---
title: "Where to Open the Next Nursing Home Facility"
author: "Christina Gao"
date: "8/12/2021"
output:
  html_document: default
  pdf_document: default
  word_document: default
editor_options: 
  markdown: 
    wrap: 72
---

# Market Expansion Analysis

# 1. Data Preparation

## 1.1 Load Packages

```{r setup, include=FALSE}
# Load packages
library(leaflet) # open-source JavaScript libraries for interactive maps
library(tidyverse) # data manipulation 
library(leaflet.extras) # add-in functionality for leaflet package
library(rgdal) # vector map data
library(sf) # encode spatial vector data
library(readxl) # read excel data 
library(dplyr) # data manipulation
library(datasets) # built-in datasets within R 
library(tidycensus) # interface with US Census Bureau's data APIs
library(censusapi) # wrapper for the United States Census Bureau's APIs
library(htmltools) # customize the user interface (UI) 
```

## 1.2 Clear Global Environment & Set Seed

```{r}
# Clear the global env variables
rm(list=ls())

# Set seed so code can be reproduced
set.seed(2021)
```

## 1.3 Load File

```{r}
# Load nursing home dataset
brookdale <- read_excel("brookdale_senior_raw.xlsx")

# View top 10 observations
head(brookdale, n = 10)

# View the struction of the brookdale file 
str(brookdale)
```

**Summary:**

There are 13 predictors and 776 observations. Some information about
each predictor:

1.  **Name:** the names of each facility
2.  **Address:** the address of each facility
3.  **City:** the city of each facility
4.  **State:** the state of each facility
5.  **Zip Code:** the zip code of each facility
6.  **Type:** there are 4 types of the open facility: assisted care,
    nursing home, assisted living, and continuing care retirement
    community
7.  **Status:** whether or not the facility is still operated under
    Brookdale
8.  **Population:** numbers of patients in each facility
9.  **County:** the county of each facility
10. **Latitude:** the latitude of each facility
11. **Longitude:** the longitude of each facility
12. **Beds:** numbers of beds in each facility
13. **SourceType:** different types of a nursing home to identify one
    facility from another(there are 23 types)

# 2. Data Exploration

## 2.1 Examine Closed Facilities

```{r}
# Create a leaflet map to display all the closed facilities
closed_facilities <- 
  brookdale %>%
  filter(STATUS == "CLOSED") # filter facilities that have been closed
  
# Create a leaflet map on closed_facilities var
leaflet(closed_facilities) %>%
  addProviderTiles("Esri.WorldStreetMap") %>%
  addCircles(radius = 100, color = "red")

```

**\*\*Summary:\*\***

The closed facilities are spread across the U.S., not just in a few
states.

## 2.2 Display Numbers of Closed Facilities

```{r}
# Display how many locations have been closed at that state
leaflet(closed_facilities) %>%
  addTiles() %>% 
  addMarkers(clusterOptions = markerClusterOptions(freezeAtZoom = 3))
```

**\*\*Summary:\*\***

-   6 closed facilities near Washington D.C. 

-   6 closed facilities in Panhandle Texas 

-   11 closed facilities in Washington state 

-   2 closed facilities in California 

## 2.3 Removed Closed Facilities from Dataset

```{r}
# Count how many facilities have been closed
brookdale %>%
  count(STATUS)

# Create a tibble named open_facilities
open_facilities <-
  brookdale %>%
  filter(STATUS == "OPEN") %>%
  select(-STATUS)
```

**\*\*Summary:\*\***

-   there are a total of **776** facilities

    -   **25** facilities have been closed 

    -   **751** still remained open 

## 2.4 Examine Still Open Facilities

```{r}
# Map out the existing brookdale nursing home facilities on a heatmap 
# identify where brookdale has presence in and what states brookdale have not yet expand into

# create a heatmap
brookdale_heatmap <-
  open_facilities %>%
  leaflet() %>%
  addProviderTiles("CartoDB") %>%
  addHeatmap(radius = 6)
  

# print the brookdale heatmap
print(brookdale_heatmap)
```

**\*\*Summary:\*\***

We can see the majority of still open facilities are located in or near
metropolitan cities.

## 2.5 Display the Numbers of Facilities are in each State

```{r}
# Summarizing how many nursing home locations there are in each existing market 

# Create a tibble named "brookdale existing locations" and count how many nursing home facilities there are
# and arrange them in order of descending
brookdale_existing_locations <- 
  open_facilities %>%
  count(STATE) %>%
  arrange(desc(n))

# Print the facilities count 
print(brookdale_existing_locations)
```

**\*\*Summary:\*\***

-   Brookdale has the most market presence in Texas, Florida, and
    California with 108, 92, and 79 open facilities, respectively 

-   in some states, Brookdale has barely any market presence, for
    example, in states like Delaware, Georgia, Montona, and Wyoming,
    there are only 2 open facilities, and in Kentucky, and West
    Virginia, Brookdale only has 1 open facility

```{r}
# display the above summary and put into a leaflet map
leaflet(open_facilities) %>%
  addTiles() %>% 
  addMarkers(clusterOptions = markerClusterOptions(freezeAtZoom = 4))

```

## 2.6 Identify Potential White Space Opportunities

```{r}
# Identify which states brookdale does not has market presence in  

# Using the %in% operator ! to determine which states brookdale does not has market presence in  
state.abb %in% brookdale_existing_locations$STATE
brookdale_existing_locations %in% brookdale

# Save the states that brookdale does not has market presence in a vector 
no_market_presence <- state.abb[!state.abb %in% brookdale_existing_locations$STATE]

# Print the facilities count 
print(no_market_presence)
```

\*\*Summary:\*\*

-   there are 14 states that are possible white space opportunities that
    Brookdale can explore 

    -   Arkansas, Hawaii, Iowa, Maine, Mississippi, Nevada, New
        Hampshire, New Mexico, North Dakota, Oregon, Pennsylvania, South
        Dakota, and Vermont

# 3. Explore US Census Bureau Data

## 3.1 Analyze Elderly Populations' Estimates through US Census Bureau Data

```{r echo=FALSE}
# Use census API to retrieve elder pop. estimate 

# Load all variable codes through API
# and saved the retrieve data of ACS5 from us census 
acs5 <- load_variables(year = 2019, dataset = "acs5")

# view(acs5)

# Filter the variable by one concept - "sex by age"
sex_by_age <- acs5 %>% 
  filter(concept == "SEX BY AGE")

# view(sex_by_age)

# Name and save the variables of total age group 65 and over for both sexes as a vector named elder_var
elder_var <- c( male_65_66_age = "B01001_020",
                male_67_69_age = "B01001_021",
                male_70_74_age = "B01001_022",
                male_75_79_age = "B01001_023",
                male_80_84_age = "B01001_024",
                male_84over_age = "B01001_025",
                female_65_66_age = "B01001_044",
                female_67_69_age = "B01001_045",
                female_70_74_age = "B01001_046",
                female_75_79_age = "B01001_047",
                female_80_84_age = "B01001_048",
                female_84over_age = "B01001_049")

# Retrieve the 5yr ACS data based on state, county, year 
elder_acs5 <- get_acs(state = "OR", geography = "county", variables = elder_var,
                        geometry = TRUE, year = 2019)

print(elder_acs5)

```

**\*\*Summary:\*\***

Conducted market research and found that Oregon is one of the fastest
states that has a growing population of older adults that account
around: 

-   17.6% out of its total population 

-   according to seniorhousingnews.com, OR is one of the states that has
    a significantly high use rate of using assisted living facilities of
    around 166 as compared to the national average of 62 

(**NOTE:** I am using the 5-yr ACS from 2015-2019, as it has a smaller
margins of error as compared to 1-yr ACS on 2019 data)

Reference:
([https://seniorhousingnews.com/2016/09/25/states-seniors-use-assisted-living/)](https://seniorhousingnews.com/2016/09/25/states-seniors-use-assisted-living/))

## 3.2 Display Elderly Population in Oregon by County

```{r}
# Using the group by function to group the elder_acs5 var to determine the highest est. elderly pop.
proposed_loc <- elder_acs5 %>%
  group_by(NAME) %>%
  summarize(totalEst = sum(estimate)) %>%
  arrange(desc(totalEst))

# Print proposed_loc
print(proposed_loc)

# Create a color palette to color map by county pop estimate
oregon_pal <- colorNumeric(palette = "plasma", domain = proposed_loc$estimate) # assign specific pal to the map

OR_pop_map <-
  proposed_loc %>%
  leaflet() %>%
  addProviderTiles("CartoDB") %>%
  addPolygons(stroke = FALSE, 
              smoothFactor = 0.2, 
              fillOpacity = 0.6, 
              color = ~oregon_pal(totalEst),
              label = ~paste0(NAME, ": ", formatC(totalEst, big.mark = ","))) %>% # adding label to the map
  addLegend(pal = oregon_pal, values = ~totalEst, title = "Elders Population by County")

# Print the elders pop of OR by county
print(OR_pop_map)
```

```{r}
# Using the group by function to group the elder_acs5 var to determine the highest est. elderly pop.
proposed_loc <- elder_acs5 %>%
  group_by(NAME) %>%
  summarize(totalEst = sum(estimate)) %>%
  arrange(desc(totalEst))

# Print proposed_loc
print(proposed_loc)

# Create a color palette to color map by county pop estimate
oregon_pal <- colorNumeric(palette = "magma", domain = proposed_loc$estimate)


OR_pop_map <-
  elder_acs5 %>%
  group_by(NAME) %>%
  summarize(totalEst = sum(estimate)) %>%
  arrange(desc(totalEst)) %>%
  leaflet() %>%
  addProviderTiles("CartoDB") %>%
  addPolygons(stroke = FALSE, smoothFactor = 0.2, fillOpacity = 0.6, color = ~oregon_pal(totalEst)) %>%
  addLegend(pal = oregon_pal, values = ~totalEst, title = "Elders Population by County", opacity = 2)

print(OR_pop_map)
```

\*\*Summary:\*\*

-   Based on the US census estimate of elderly population, I found that
    Multnomah County and Washington County have the highest projected
    elderly population in 2019 

-   so as for the preliminary research, I will proposed these two
    counties

# 4. Recommendation

## 4.1 Load Proposed Locations with States that Border OR

```{r}
# Load the OR_proposed_county dataset
oregon_proposed_county <- read_excel("OR_proposed_county.xlsx")

# View top 10 observations
head(oregon_proposed_county, n = 10)
head(open_facilities)

# Filter and bind the proposed county to states that border OR for latter analysis 
brookdale_research <-
  open_facilities %>%
  filter(STATE %in% c("CA", "WA", "ID", "NV")) %>%
  select(COUNTY, STATE, LATITUDE, LONGITUDE) %>%
  mutate(STATUS = "OPEN") %>%
  bind_rows(oregon_proposed_county)
  

# Print brookdale_research
print(brookdale_research)
  
```

## 4.2 Map Both Open and Proposed Locations

```{r}
# Create a blue and red color palette to distinguish between open and proposed locations
pal <- colorFactor(palette = c("Blue", "Red"), 
                   domain = c("OPEN", "PROPOSED"))

# Map both the open and proposed locations
proposed_map <- brookdale_research %>%
  leaflet() %>%
  addProviderTiles("CartoDB") %>%  # add CartoDB provider tile
  addCircles(color = ~pal(STATUS)) %>% # apply the pal color palette
  addCircles(data = oregon_proposed_county, 
             weight = 2,   # parameter to control the circle boundary width
             radius = 100 * 1609.34, # drawing circles within 100 miles of the two proposed locations 
             color = ~pal(STATUS),
             fill = FALSE) %>%      # draw a circle with a 100 miles around the proposed locations
  addMarkers(lng = -122.5385, lat = 45.51668, popup = "Multnomah County")

# Print proposed_map
print(proposed_map)


# # create a df of lat & lng of proposed locations
# name <- c("Multnomah County", "Washington County")
# 
# leaflet(oregon_proposed_county) %>% addTiles() %>%
#   addMarkers(lng = -122.5385, lat = 45.51668	, popup = "Multnomah County")
```

**\*\*Recommendation:\*\***

Based on my research, I recommend Brookdale to expand its market
presence in Oregon, specifically in Multnomah County and Washington
County. This is because I found that OR is one of the states with a
growing population of older adults and has a significant usage rate of
using assisted living facilities.

As shown above, in the map, I believe anywhere within the circle of
radius could be a potential white space for Brookdale to explore for its
next expansion project, whether that will be through acquisition or
de-novo development.
